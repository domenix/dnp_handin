@page
<!-- Clever hack for the vsCode razor formatter -->
@model IndexModel
<!-- Clever hack for the vsCode razor formatter -->
@{ ViewData["Title"] = "Screenings"; }
<!-- Clever hack for the vsCode razor formatter -->
@Html.Partial("_StatusMessage", Model.StatusMessage)
<div class="row">
    <div class="col-md-6">
        <h4>@ViewData["Title"]</h4>
        <div asp-validation-summary="All" class="text-danger"></div>
        <div class="form-group" id="screenings">
        </div>
    </div>
    <div class="col-md-6">
        <h4>Add Screening</h4>
        <ul class="list-group contrast-text">
            <li class="list-group-item">
                Date: <input id="newScreeningDate" type="datetime-local" class="form-control" />
            </li>
            <li class="list-group-item">
                Movie: <select id="newScreeningMovie"></select>
            </li>
        </ul>
        <button id="saveButton" type="button" class="btn btn-default btn-lg">Save</button>
    </div>
</div>

@section Scripts { @await Html.PartialAsync("_ValidationScriptsPartial")
<script>
    {
        function getScreenings() {
            return fetch("/api/screenings").then(res => res.json());
        }

        function getMovies() {
            return fetch("/api/movies").then(res => res.json());
        }

        function deleteScreening(id) {
            return fetch("/api/screenings/" + id, {
                method: "DELETE"
            })
        }

        async function createScreening(date, movieId) {
            if (!date) {
                throw new Error("You must enter a date")
            }
            if (Date.parse(date) < Date.now()) {
                throw new Error("Invalid date")
            }
            return fetch("/api/screenings/", {
                method: "POST",
                body: JSON.stringify({
                    date,
                    movieId
                })
            })
        }

        function buildScreening(id, title, date, duration, tickets) {
            //god I want React right about now
            const startDate = moment(date);
            const formattedStartDate = startDate.format("Do/MMM h:mm");
            const endDate = startDate.add(duration, "minutes");
            const formattedEndDate = endDate.format("h:mm");
            return $("<div/>", {
                class: "panel panel-default",
                html: $("<div/>", {
                    class: "panel-heading",
                    html: $("<div/>", {
                        class: "panel-title contrast-text",
                        text: title
                    })
                }).add($("<div/>", {
                    style: "color: black; display: flex; ",
                    class: "panel-body",
                    text: `${formattedStartDate} - ${formattedEndDate}, duration: ${duration} minutes, Tickets sold: ${tickets}`
                }).append($("<button/>", {
                    on: {
                        async click() {
                            await deleteScreening(id)
                            refreshScreenings()
                        }
                    },
                    class: "btn btn-default btn-lg",
                    type: "button",
                    html: $("<span/>", {
                        class: "glyphicon glyphicon-trash"
                    })
                })))
            });
        }


        const screeningsDom = $("#screenings");
        async function refreshScreenings() {
            const screenings = await getScreenings();
            screeningsDom.empty()
            for (const {
                    Id,
                    Date: date,
                    Tickets: {
                        length
                    },
                    Movie: {
                        Title,
                        Duration
                    }
                } of screenings) {
                buildScreening(Id, Title, date, Duration, length).appendTo(screeningsDom);
            }
        }
        const moviesDom = $("#newScreeningMovie");
        async function refreshMovies() {
            const movies = await getMovies();
            moviesDom.empty();
            for (const {
                    Title,
                    Id
                } of movies) {
                $("<option/>", {
                    value: Id,
                    text: Title
                }).appendTo(moviesDom);
            }
        }
        const dateDom = $("#newScreeningDate");
        $("#saveButton").click(async function() {
            await createScreening(dateDom.val(), parseInt(moviesDom.val())).catch(err => {
                //Would be a lot better with a snackbar or something like that but no time so alert will have to do
                alert(err.message);
            })
            refreshScreenings();
            refreshMovies();
        })

        refreshMovies();
        refreshScreenings();
        const date = moment().add(1, "hour").toISOString(true);
        console.log(date.substr(0, date.length))
        dateDom.val(date.substr(0, date.length - 13), ) //set date to now + 1h without seconds
    }
</script>
}